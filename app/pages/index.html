<!DOCTYPE html>
<html>
  <head>
    <title>Image Analyzer</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width,initial-scale=1">
  </head>

  <body>
    <div class="container">
      <h1>Image Analyzer</h1>
      <p class="subtitle">Upload a photo to detect objects</p>

      <div class="upload-area">
        <label for="photo_input">Take a photo or choose an image:</label>
        <input id="photo_input" type="file" accept="image/*" capture="environment">
        <div id="image-container">
          <img id="thumbnail">
        </div>
      </div>

      <button id="upload_btn" disabled>Upload + Analyze</button>

      <div id="object-description"></div>

      <div id="warnings"></div>

      <img class="puppy" src="https://picsum.photos/id/237/300/300" alt="Cute puppy">

      <div class="footer">
        Powered by AI vision
      </div>
    </div>

    <script>
      let jpegBlob = null;
      let imageWidth = 0;
      let imageHeight = 0;

      photo_input.onchange = () => {
        clearBoundingBoxes();
        warnings.textContent = "";
        upload_btn.disabled = true;
        jpegBlob = null;

        const img = new Image();
        img.onload = () => {
          imageWidth = img.width;
          imageHeight = img.height;
          const c = Object.assign(document.createElement("canvas"), {
            width: img.width,
            height: img.height
          });
          c.getContext("2d").drawImage(img, 0, 0);

          c.toBlob(b => {
            jpegBlob = b;
            thumbnail.src = URL.createObjectURL(b);
            upload_btn.disabled = false;
          }, "image/jpeg");
        };
        img.src = URL.createObjectURL(photo_input.files[0]);
      };

      function clearBoundingBoxes() {
        document.querySelectorAll(".bbox").forEach(el => el.remove());
      }

      function renderBoundingBoxes(objects) {
        clearBoundingBoxes();
        const container = document.getElementById("image-container");
        const img = document.getElementById("thumbnail");
        const descriptionDiv = document.getElementById("object-description");
        const displayWidth = img.clientWidth;
        const displayHeight = img.clientHeight;

        objects.forEach(obj => {
          const box = obj.box || {};
          const div = document.createElement("div");
          div.className = "bbox";
          div.style.left = (box.x * displayWidth) + "px";
          div.style.top = (box.y * displayHeight) + "px";
          div.style.width = (box.w * displayWidth) + "px";
          div.style.height = (box.h * displayHeight) + "px";

          const description = obj.description || obj.label || "Unknown";
          div.addEventListener("mouseenter", () => {
            descriptionDiv.textContent = description;
          });
          div.addEventListener("mouseleave", () => {
            descriptionDiv.textContent = "";
          });

          container.appendChild(div);
        });
      }

      upload_btn.onclick = async () => {
        if (!jpegBlob) {
          warnings.textContent = "No JPEG ready yet.";
          return;
        }

        clearBoundingBoxes();
        warnings.textContent = "Analyzing...";

        const form = new FormData();
        form.append("file", jpegBlob, "photo.jpg");

        try {
          const res = await fetch("/upload", {
            method: "POST",
            body: form
          });

          const data = await res.json();
          if (!res.ok) {
            warnings.textContent = "Server error: " + (data.error || JSON.stringify(data));
            return;
          }

          if (data.warnings && data.warnings.length > 0) {
            warnings.textContent = "Warnings:\n" + data.warnings.map(w => "- " + w).join("\n");
          } else {
            warnings.textContent = "";
          }

          if (data.objects && data.objects.length > 0) {
            renderBoundingBoxes(data.objects);
          }
        } catch (e) {
          warnings.textContent = "Network error: " + e;
        }
      };
    </script>
  </body>
</html>
